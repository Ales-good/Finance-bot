<!DOCTYPE html>
<html>
<head>
    <title>Finance Bot - –ü–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f5f5; }
        
        .container { max-width: 100%; padding: 0; }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .tabs { 
            display: flex; 
            background: white; 
            border-bottom: 1px solid #e1e1e1;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .tab { 
            flex: 1; 
            padding: 15px; 
            text-align: center; 
            border: none;
            background: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active { 
            background: #007aff; 
            color: white;
        }
        
        .tab-content { 
            display: none; 
            padding: 20px;
            min-height: 80vh;
        }
        
        .tab-content.active { display: block; }
        
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        .card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .btn {
            padding: 12px 20px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin: 5px 0;
        }
        
        .btn-success { background: #34c759; }
        .btn-danger { background: #ff3b30; }
        .btn-secondary { background: #8e8e93; }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input, select, textarea { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e1e1e1; 
            border-radius: 10px; 
            font-size: 16px;
        }
        
        /* –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä */
        .calculator { 
            background: white; 
            padding: 15px; 
            border-radius: 15px; 
            margin-bottom: 15px;
        }
        
        .amount-display { 
            text-align: center; 
            font-size: 24px; 
            font-weight: bold; 
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .buttons { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 10px; 
        }
        
        /* –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ */
        .space-card {
            border: 2px solid #e1e1e1;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .space-card.active {
            border-color: #007aff;
            background: #f0f8ff;
        }
        
        .space-card.personal { border-left: 4px solid #34c759; }
        .space-card.private { border-left: 4px solid #007aff; }
        .space-card.public { border-left: 4px solid #5856d6; }
        
        .space-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .space-type {
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .type-personal { background: #d4edda; color: #155724; }
        .type-private { background: #d1ecf1; color: #0c5460; }
        .type-public { background: #e2e3e5; color: #383d41; }
        
        /* –£—á–∞—Å—Ç–Ω–∏–∫–∏ */
        .member-list {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e1e1e1;
        }
        
        .member-role {
            font-size: 12px;
            color: #666;
            padding: 2px 6px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        /* –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ */
        .chart-container {
            height: 200px;
            margin: 20px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        .stat-card {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            margin: 5px 0;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 20px;
            color: #ff3b30;
            background: #ffeaea;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .invite-section {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }
        
        .invite-code {
            font-family: monospace;
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 2px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('expense')">üí∏ –¢—Ä–∞—Ç–∞</button>
            <button class="tab" onclick="showTab('spaces')">üè† –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞</button>
            <button class="tab" onclick="showTab('analytics')">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞—Ç—ã -->
        <div id="expenseTab" class="tab-content active">
            <div class="card">
                <h3>üí∏ –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞—Ç—É</h3>
                
                <!-- –í—ã–±–æ—Ä –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ -->
                <div class="input-group">
                    <label>üè† –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ</label>
                    <select id="spaceSelect" onchange="updateSpaceInfo()">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                    </select>
                </div>
                
                <!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä -->
                <div class="calculator">
                    <div class="amount-display">
                        <span id="amountDisplay">0 ‚ÇΩ</span>
                    </div>
                    
                    <div class="buttons" id="calculatorButtons">
                        <!-- –ö–Ω–æ–ø–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                    
                    <button class="btn btn-secondary" onclick="clearAmount()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
                
                <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏—è -->
                <div class="input-group">
                    <label>üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select id="categorySelect">
                        <option value="–ü—Ä–æ–¥—É–∫—Ç—ã">üõí –ü—Ä–æ–¥—É–∫—Ç—ã</option>
                        <option value="–ö–∞—Ñ–µ">üçΩÔ∏è –ö–∞—Ñ–µ</option>
                        <option value="–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç">üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</option>
                        <option value="–î–æ–º">üè† –î–æ–º</option>
                        <option value="–û–¥–µ–∂–¥–∞">üëï –û–¥–µ–∂–¥–∞</option>
                        <option value="–ó–¥–æ—Ä–æ–≤—å–µ">üè• –ó–¥–æ—Ä–æ–≤—å–µ</option>
                        <option value="–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">üé≠ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è</option>
                        <option value="–ü–æ–¥–ø–∏—Å–∫–∏">üì± –ü–æ–¥–ø–∏—Å–∫–∏</option>
                        <option value="–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã">üì¶ –ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å—ã</option>
                        <option value="–î—Ä—É–≥–æ–µ">üìä –î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>
                
                <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                <div class="input-group">
                    <label>üìù –û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <textarea id="description" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û–±–µ–¥ –≤ —Å—Ç–æ–ª–æ–≤–æ–π" rows="2"></textarea>
                </div>
                
                <button class="btn btn-success" onclick="submitExpense()">‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞—Ç—É</button>
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞–º–∏ -->
        <div id="spacesTab" class="tab-content">
            <div class="card">
                <h3>üè† –ú–æ–∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞</h3>
                <div id="spacesList">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤...</div>
                </div>
                
                <button class="btn" onclick="showCreateSpaceForm()">‚ûï –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ</button>
            </div>
            
            <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ -->
            <div id="createSpaceForm" class="card" style="display: none;">
                <h3>üìù –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞</h3>
                
                <div class="input-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞</label>
                    <input type="text" id="spaceName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–µ–º–µ–π–Ω—ã–π –±—é–¥–∂–µ—Ç">
                </div>
                
                <div class="input-group">
                    <label>–¢–∏–ø –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞</label>
                    <select id="spaceType">
                        <option value="private">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –ó–∞–∫—Ä—ã—Ç–∞—è –≥—Ä—É–ø–ø–∞ (—Å–µ–º—å—è/–¥—Ä—É–∑—å—è)</option>
                        <option value="public">üåê –ü—É–±–ª–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label>–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <textarea id="spaceDescription" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞" rows="2"></textarea>
                </div>
                
                <button class="btn btn-success" onclick="createSpace()">‚úÖ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ</button>
                <button class="btn btn-secondary" onclick="hideCreateSpaceForm()">‚ùå –û—Ç–º–µ–Ω–∞</button>
            </div>
            
            <!-- –î–µ—Ç–∞–ª–∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ -->
            <div id="spaceDetails" class="card" style="display: none;">
                <h3 id="spaceDetailTitle">–î–µ—Ç–∞–ª–∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞</h3>
                
                <div class="invite-section" id="inviteSection">
                    <h4>üîó –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</h4>
                    <div class="invite-code" id="inviteCode">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <button class="btn" onclick="shareInvite()">üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ–º</button>
                    <p style="font-size: 12px; margin-top: 10px; color: #666;">
                        –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –¥—Ä—É–∑—å—è–º. –û–Ω–∏ –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—è—Ç –µ–≥–æ –±–æ—Ç—É —á—Ç–æ–±—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è.
                    </p>
                </div>
                
                <h4>üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏</h4>
                <div class="member-list" id="membersList">
                    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤...</div>
                </div>
                
                <button class="btn btn-secondary" onclick="backToSpaces()">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</button>
            </div>
        </div>
        
        <!-- –í–∫–ª–∞–¥–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ -->
        <div id="analyticsTab" class="tab-content">
            <div class="card">
                <h3>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
                
                <div class="input-group">
                    <label>üè† –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</label>
                    <select id="analyticsSpaceSelect" onchange="loadAnalytics()">
                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                    </select>
                </div>
                
                <div id="analyticsContent">
                    <div class="loading">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentAmount = 0;
        let currentSpaceId = null;
        let userSpaces = [];
        let tg = window.Telegram.WebApp;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        tg.expand();
        tg.ready();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function initializeApp() {
            await loadUserSpaces();
            updateCalculatorButtons();
            loadSpacesList();
            loadAnalyticsSpaces();
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loadUserSpaces() {
            try {
                const initData = tg.initData;
                const response = await fetch('/get_user_spaces', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ initData })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    userSpaces = data.spaces;
                    updateSpaceSelect();
                } else {
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤');
                }
            } catch (error) {
                console.error('Error loading spaces:', error);
                showError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
        function updateSpaceSelect() {
            const select = document.getElementById('spaceSelect');
            const analyticsSelect = document.getElementById('analyticsSpaceSelect');
            
            select.innerHTML = '';
            analyticsSelect.innerHTML = '';
            
            userSpaces.forEach(space => {
                const option = document.createElement('option');
                option.value = space.id;
                option.textContent = `${getSpaceEmoji(space.space_type)} ${space.name}`;
                select.appendChild(option.cloneNode(true));
                analyticsSelect.appendChild(option);
            });
            
            if (userSpaces.length > 0) {
                currentSpaceId = userSpaces[0].id;
            }
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–º–æ–¥–∑–∏ –¥–ª—è —Ç–∏–ø–∞ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
        function getSpaceEmoji(type) {
            const emojis = {
                'personal': 'üè†',
                'private': 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
                'public': 'üåê'
            };
            return emojis[type] || 'üìÅ';
        }
        
        // –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
        function updateCalculatorButtons() {
            const buttonsContainer = document.getElementById('calculatorButtons');
            const steps = [100, 200, 500, 1000, 2000, 5000];
            
            buttonsContainer.innerHTML = '';
            
            steps.forEach(step => {
                const button = document.createElement('button');
                button.className = 'btn';
                button.textContent = `+${step}`;
                button.onclick = () => addAmount(step);
                buttonsContainer.appendChild(button);
            });
        }
        
        function addAmount(amount) {
            currentAmount += amount;
            updateDisplay();
        }
        
        function clearAmount() {
            currentAmount = 0;
            updateDisplay();
        }
        
        function updateDisplay() {
            document.getElementById('amountDisplay').textContent = `${currentAmount.toLocaleString('ru-RU')} ‚ÇΩ`;
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∞–º–∏
        function showTab(tabName) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (tabName === 'spaces') {
                loadSpacesList();
            } else if (tabName === 'analytics') {
                loadAnalytics();
            }
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞–º–∏
        function loadSpacesList() {
            const container = document.getElementById('spacesList');
            
            if (userSpaces.length === 0) {
                container.innerHTML = '<div class="error">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤</div>';
                return;
            }
            
            container.innerHTML = userSpaces.map(space => `
                <div class="space-card ${space.space_type} ${space.id === currentSpaceId ? 'active' : ''}" 
                     onclick="selectSpace(${space.id})">
                    <div class="space-header">
                        <strong>${getSpaceEmoji(space.space_type)} ${space.name}</strong>
                        <span class="space-type type-${space.space_type}">
                            ${getSpaceTypeName(space.space_type)}
                        </span>
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        ${space.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}
                    </div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">
                        –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${space.member_count || 1}
                    </div>
                </div>
            `).join('');
        }
        
        function getSpaceTypeName(type) {
            const names = {
                'personal': '–õ–∏—á–Ω–æ–µ',
                'private': '–ó–∞–∫—Ä—ã—Ç–∞—è –≥—Ä—É–ø–ø–∞',
                'public': '–ü—É–±–ª–∏—á–Ω–æ–µ'
            };
            return names[type] || type;
        }
        
        function selectSpace(spaceId) {
            currentSpaceId = spaceId;
            loadSpacesList();
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
            const space = userSpaces.find(s => s.id === spaceId);
            if (space) {
                document.getElementById('spaceDetailTitle').textContent = `${getSpaceEmoji(space.space_type)} ${space.name}`;
                document.getElementById('inviteCode').textContent = space.invite_code;
                document.getElementById('spacesList').style.display = 'none';
                document.getElementById('createSpaceForm').style.display = 'none';
                document.getElementById('spaceDetails').style.display = 'block';
                
                loadSpaceMembers(spaceId);
            }
        }
        
        async function loadSpaceMembers(spaceId) {
            try {
                const response = await fetch('/get_space_members', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        initData: tg.initData,
                        spaceId: spaceId
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayMembers(data.members);
                }
            } catch (error) {
                console.error('Error loading members:', error);
            }
        }
        
        function displayMembers(members) {
            const container = document.getElementById('membersList');
            
            if (!members || members.length === 0) {
                container.innerHTML = '<div class="error">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>';
                return;
            }
            
            container.innerHTML = members.map(member => `
                <div class="member-item">
                    <div>
                        <strong>${member.user_name}</strong>
                        <div class="member-role">${member.role}</div>
                    </div>
                    <div style="font-size: 12px; color: #666;">
                        ${new Date(member.joined_at).toLocaleDateString('ru-RU')}
                    </div>
                </div>
            `).join('');
        }
        
        function showCreateSpaceForm() {
            document.getElementById('spacesList').style.display = 'none';
            document.getElementById('createSpaceForm').style.display = 'block';
            document.getElementById('spaceDetails').style.display = 'none';
        }
        
        function hideCreateSpaceForm() {
            document.getElementById('spacesList').style.display = 'block';
            document.getElementById('createSpaceForm').style.display = 'none';
            document.getElementById('spaceDetails').style.display = 'none';
        }
        
        async function createSpace() {
            const name = document.getElementById('spaceName').value.trim();
            const type = document.getElementById('spaceType').value;
            const description = document.getElementById('spaceDescription').value.trim();
            
            if (!name) {
                showError('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞');
                return;
            }
            
            try {
                const response = await fetch('/create_space', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        name: name,
                        type: type,
                        description: description
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        await loadUserSpaces();
                        hideCreateSpaceForm();
                        showTab('spaces');
                    } else {
                        showError(data.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è');
                    }
                }
            } catch (error) {
                console.error('Error creating space:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞');
            }
        }
        
        function backToSpaces() {
            document.getElementById('spacesList').style.display = 'block';
            document.getElementById('spaceDetails').style.display = 'none';
            document.getElementById('createSpaceForm').style.display = 'none';
        }
        
        function shareInvite() {
            const code = document.getElementById('inviteCode').textContent;
            const message = `–ü—Ä–∏–≤–µ—Ç! –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –º–æ–µ–º—É —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–º—É –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤—É. –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–¥: ${code}\n\n–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å —ç—Ç–æ—Ç –∫–æ–¥ –±–æ—Ç—É @${tg.initDataUnsafe.user?.username || '—Ç–≤–æ–µ–≥–æ_–±–æ—Ç–∞'}`;
            
            if (navigator.share) {
                navigator.share({
                    title: '–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ',
                    text: message
                });
            } else {
                // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
                navigator.clipboard.writeText(message).then(() => {
                    tg.showPopup({
                        title: '–£—Å–ø–µ—à–Ω–æ!',
                        message: '–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–≥–æ –¥—Ä—É–≥—É.',
                        buttons: [{ type: 'ok' }]
                    });
                });
            }
        }
        
        // –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
        function loadAnalyticsSpaces() {
            const select = document.getElementById('analyticsSpaceSelect');
            select.innerHTML = '';
            
            userSpaces.forEach(space => {
                const option = document.createElement('option');
                option.value = space.id;
                option.textContent = `${getSpaceEmoji(space.space_type)} ${space.name}`;
                select.appendChild(option);
            });
        }
        
        async function loadAnalytics() {
            const spaceId = document.getElementById('analyticsSpaceSelect').value;
            if (!spaceId) return;
            
            const container = document.getElementById('analyticsContent');
            container.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...</div>';
            
            try {
                const response = await fetch('/get_analytics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        spaceId: spaceId
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayAnalytics(data);
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
                container.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</div>';
            }
        }
        
        function displayAnalytics(data) {
            const container = document.getElementById('analyticsContent');
            
            if (!data || !data.categories) {
                container.innerHTML = '<div class="error">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>';
                return;
            }
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const totalSpent = data.categories.reduce((sum, cat) => sum + cat.total, 0);
            
            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">–í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ</div>
                        <div class="stat-value">${totalSpent.toLocaleString('ru-RU')} ‚ÇΩ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞—Ç</div>
                        <div class="stat-value">${data.total_count || 0}</div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="analyticsChart"></canvas>
                </div>
                
                <h4>üìã –î–µ—Ç–∞–ª–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h4>
                ${data.categories.map(cat => `
                    <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e1e1e1;">
                        <span>${cat.category}</span>
                        <strong>${cat.total.toLocaleString('ru-RU')} ‚ÇΩ</strong>
                    </div>
                `).join('')}
            `;
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
            createChart(data.categories);
        }
        
        function createChart(categories) {
            const ctx = document.getElementById('analyticsChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories.map(cat => cat.category),
                    datasets: [{
                        data: categories.map(cat => cat.total),
                        backgroundColor: [
                            '#007aff', '#34c759', '#ff9500', '#5856d6', '#ff3b30',
                            '#af52de', '#ffcc00', '#32d74b', '#64d2ff', '#bf5af2'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞—Ç—ã
        async function submitExpense() {
            if (currentAmount <= 0) {
                showError('–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É —Ç—Ä–∞—Ç—ã');
                return;
            }
            
            const category = document.getElementById('categorySelect').value;
            const description = document.getElementById('description').value;
            const spaceId = document.getElementById('spaceSelect').value;
            
            if (!spaceId) {
                showError('–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ');
                return;
            }
            
            try {
                const response = await fetch('/add_expense', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: tg.initData,
                        amount: currentAmount,
                        category: category,
                        description: description,
                        spaceId: spaceId
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        tg.showPopup({
                            title: '–£—Å–ø–µ—à–Ω–æ!',
                            message: '–¢—Ä–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞',
                            buttons: [{ type: 'ok' }]
                        });
                        
                        // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
                        currentAmount = 0;
                        updateDisplay();
                        document.getElementById('description').value = '';
                    } else {
                        showError(data.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
                    }
                }
            } catch (error) {
                console.error('Error adding expense:', error);
                showError('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞—Ç—ã');
            }
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function showError(message) {
            tg.showPopup({
                title: '–û—à–∏–±–∫–∞',
                message: message,
                buttons: [{ type: 'ok' }]
            });
        }
        
        function showSuccess(message) {
            tg.showPopup({
                title: '–£—Å–ø–µ—à–Ω–æ!',
                message: message,
                buttons: [{ type: 'ok' }]
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
